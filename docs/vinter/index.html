<html>
  <head>
    <meta charset="UTF-8" />
    <title>Vineyard Simulator</title>
    <script src="https://unpkg.com/react@16.2.0/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@16.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/lodash@4.17.4/lodash.min.js"></script>
    <script src="https://unpkg.com/redux@3.7.2/dist/redux.min.js"></script>
    <script src="https://unpkg.com/react-redux@5.0.6/dist/react-redux.min.js"></script>
    <script src="https://unpkg.com/classnames@2.2.5/index.js"></script>
    <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
    <style type="text/css">
      #app {
        height: 100%;
      }

      #header {
        width: 100%;
        border-bottom: solid 1px black;
      }

      #header .tab {
        display: inline-block;
        margin-left: 1em;
        padding: 0.3em;
        border: solid 1px black;
        border-bottom: 0;
        cursor: pointer;
      }

      #header .tab.selected {
        background-color: lightblue;
      }

      #header #header-info {
        display: inline-block;
        margin-left: 1em;
      }

      .view {
        min-height: 100%;
        width: 100%;
        display: flex;
      }

      .sidebar {
        width: 15em;
        background-color: lightgray;
      }

      .listing {
        padding: 0.4em;
        border-bottom: dotted 1px darkgray;
        cursor: pointer;
      }

      .listing:hover {
        font-weight: bold;
      }

      .listing.selected {
        background-color: lightblue;
      }

      .main {
        padding: 0.5em;
      }

      .vineyard {
        margin-top: 1.5em;
      }

      .show-grape-detail {
        display: inline-block;
        margin-left: 0.5em;
        cursor: pointer;
      }

      .tend-table {
        margin-top: 1.5em;
      }

      .tend-table .tend-table-header {
        font-size: 110%;
        font-weight: bold;
        border-bottom: solid 1px black;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const defaultState = 'The vines are sagging a bit';

      let initialState = {
        grapes: [
          {"fat":{"as":{"a":2,"c":6,"g":7,"q":1,"k":-9,"s":-2,"v":-2},"mg":{"a":1,"c":4,"g":3,"q":3,"k":11,"s":-2,"v":-4},"po":{"a":2,"c":3,"g":4,"q":1,"k":15,"s":-3,"v":-6},"sl":{"a":-5,"c":8,"g":3,"q":-2,"k":16,"s":0,"v":-12},"sv":{"a":1,"c":-4,"g":-6,"q":-2,"k":12,"s":4,"v":-14},"tv":{"a":4,"c":2,"g":0,"q":1,"k":-6,"s":0,"v":-3},"tl":{"a":5,"c":-1,"g":-2,"q":3,"k":9,"s":-2,"v":-12}},"musty":{"as":{"a":1,"c":2,"g":2,"q":-3,"k":15,"s":1,"v":-5},"mg":{"a":6,"c":2,"g":3,"q":3,"k":7,"s":3,"v":-14},"po":{"a":5,"c":6,"g":5,"q":1,"k":-1,"s":2,"v":-12},"sl":{"a":7,"c":8,"g":-5,"q":1,"k":15,"s":1,"v":-9},"sv":{"a":8,"c":4,"g":6,"q":0,"k":8,"s":4,"v":-6},"tv":{"a":0,"c":4,"g":-6,"q":-1,"k":-11,"s":2,"v":-8},"tl":{"a":8,"c":-2,"g":-3,"q":0,"k":-11,"s":-2,"v":-3}},"rustle":{"as":{"a":4,"c":4,"g":-5,"q":0,"k":6,"s":2,"v":-9},"mg":{"a":7,"c":-3,"g":6,"q":3,"k":5,"s":1,"v":-6},"po":{"a":5,"c":-6,"g":2,"q":3,"k":16,"s":-2,"v":-1},"sl":{"a":0,"c":8,"g":1,"q":1,"k":13,"s":2,"v":-11},"sv":{"a":6,"c":-4,"g":-5,"q":-3,"k":-11,"s":-1,"v":-4},"tv":{"a":-5,"c":0,"g":-6,"q":-2,"k":8,"s":-2,"v":-4},"tl":{"a":7,"c":1,"g":-5,"q":-3,"k":14,"s":0,"v":-5}},"sagging":{"as":{"a":4,"c":-2,"g":1,"q":0,"k":-8,"s":2,"v":-10},"mg":{"a":2,"c":-3,"g":2,"q":-3,"k":14,"s":0,"v":-5},"po":{"a":3,"c":-6,"g":-4,"q":1,"k":1,"s":3,"v":-9},"sl":{"a":-6,"c":2,"g":7,"q":4,"k":-6,"s":4,"v":-10},"sv":{"a":-6,"c":-1,"g":-4,"q":1,"k":5,"s":-3,"v":-10},"tv":{"a":-2,"c":6,"g":3,"q":2,"k":6,"s":3,"v":-10},"tl":{"a":-6,"c":4,"g":0,"q":1,"k":6,"s":-2,"v":-7}},"shimmer":{"as":{"a":-6,"c":0,"g":-2,"q":1,"k":4,"s":3,"v":-1},"mg":{"a":-4,"c":-3,"g":2,"q":-1,"k":5,"s":-1,"v":-9},"po":{"a":2,"c":8,"g":-1,"q":4,"k":-3,"s":-3,"v":-1},"sl":{"a":-5,"c":-1,"g":-2,"q":2,"k":-11,"s":-2,"v":-2},"sv":{"a":-3,"c":6,"g":8,"q":0,"k":11,"s":-3,"v":-10},"tv":{"a":0,"c":1,"g":4,"q":2,"k":-9,"s":0,"v":-14},"tl":{"a":3,"c":-4,"g":-4,"q":0,"k":4,"s":-2,"v":-10}},"shrivel":{"as":{"a":6,"c":-5,"g":2,"q":4,"k":9,"s":3,"v":-7},"mg":{"a":-2,"c":1,"g":-4,"q":-3,"k":-12,"s":-3,"v":-13},"po":{"a":-2,"c":4,"g":-3,"q":-1,"k":3,"s":4,"v":-6},"sl":{"a":8,"c":-3,"g":4,"q":3,"k":14,"s":1,"v":-6},"sv":{"a":5,"c":-2,"g":7,"q":4,"k":16,"s":2,"v":-9},"tv":{"a":-2,"c":4,"g":-6,"q":2,"k":1,"s":2,"v":-12},"tl":{"a":-4,"c":-1,"g":2,"q":4,"k":-1,"s":-1,"v":-2}},"wilting":{"as":{"a":-2,"c":5,"g":-2,"q":1,"k":4,"s":4,"v":-9},"mg":{"a":3,"c":5,"g":6,"q":2,"k":-2,"s":2,"v":-8},"po":{"a":2,"c":2,"g":-1,"q":4,"k":-7,"s":-3,"v":-11},"sl":{"a":-3,"c":3,"g":3,"q":-3,"k":-11,"s":0,"v":-12},"sv":{"a":8,"c":8,"g":0,"q":0,"k":10,"s":-1,"v":-14},"tv":{"a":5,"c":8,"g":2,"q":4,"k":8,"s":4,"v":-6},"tl":{"a":4,"c":5,"g":-1,"q":0,"k":13,"s":4,"v":-5}},"starting":11,"name":"Pascalito#356"},
{"fat":{"as":{"a":4,"c":-1,"g":7,"q":1,"k":8,"s":-39,"v":-2},"mg":{"a":4,"c":-3,"g":3,"q":3,"k":6,"s":-23,"v":-4},"po":{"a":2,"c":3,"g":4,"q":1,"k":5,"s":36,"v":-6},"sl":{"a":0,"c":3,"g":3,"q":-2,"k":1,"s":3,"v":-12},"sv":{"a":-2,"c":4,"g":-6,"q":-2,"k":-6,"s":43,"v":-14},"tv":{"a":1,"c":3,"g":0,"q":1,"k":-5,"s":15,"v":-3},"tl":{"a":0,"c":4,"g":-2,"q":3,"k":5,"s":11,"v":-12}},"musty":{"as":{"a":3,"c":-3,"g":2,"q":-1,"k":3,"s":-16,"v":-5},"mg":{"a":4,"c":-1,"g":3,"q":3,"k":0,"s":1,"v":-14},"po":{"a":0,"c":2,"g":5,"q":1,"k":-1,"s":-31,"v":-12},"sl":{"a":4,"c":1,"g":-5,"q":1,"k":-3,"s":55,"v":-9},"sv":{"a":3,"c":4,"g":6,"q":0,"k":3,"s":32,"v":-6},"tv":{"a":4,"c":0,"g":-6,"q":-1,"k":-2,"s":24,"v":-8},"tl":{"a":-1,"c":3,"g":-3,"q":0,"k":4,"s":21,"v":-3}},"rustle":{"as":{"a":4,"c":0,"g":-5,"q":0,"k":3,"s":33,"v":-9},"mg":{"a":4,"c":4,"g":6,"q":3,"k":-6,"s":34,"v":-6},"po":{"a":0,"c":0,"g":2,"q":3,"k":-5,"s":49,"v":-1},"sl":{"a":2,"c":-1,"g":1,"q":1,"k":8,"s":15,"v":-11},"sv":{"a":-2,"c":3,"g":-5,"q":-3,"k":-2,"s":-6,"v":-4},"tv":{"a":2,"c":1,"g":-6,"q":-2,"k":5,"s":46,"v":-4},"tl":{"a":-1,"c":1,"g":-5,"q":-3,"k":7,"s":-5,"v":-5}},"sagging":{"as":{"a":-3,"c":0,"g":1,"q":0,"k":7,"s":13,"v":-10},"mg":{"a":1,"c":-2,"g":2,"q":-3,"k":-5,"s":55,"v":-5},"po":{"a":2,"c":3,"g":-4,"q":1,"k":-1,"s":-37,"v":-9},"sl":{"a":-3,"c":2,"g":7,"q":4,"k":2,"s":40,"v":-10},"sv":{"a":0,"c":4,"g":-4,"q":1,"k":-1,"s":5,"v":-10},"tv":{"a":1,"c":3,"g":3,"q":2,"k":-3,"s":8,"v":-10},"tl":{"a":-3,"c":0,"g":0,"q":1,"k":-3,"s":41,"v":-7}},"shimmer":{"as":{"a":2,"c":3,"g":2,"q":4,"k":6,"s":5,"v":-7},"mg":{"a":4,"c":3,"g":-4,"q":-3,"k":1,"s":51,"v":-13},"po":{"a":3,"c":4,"g":-3,"q":-1,"k":8,"s":13,"v":-6},"sl":{"a":-1,"c":2,"g":4,"q":3,"k":-5,"s":52,"v":-6},"sv":{"a":-2,"c":2,"g":7,"q":4,"k":5,"s":31,"v":-9},"tv":{"a":4,"c":2,"g":-6,"q":2,"k":-2,"s":31,"v":-12},"tl":{"a":4,"c":-3,"g":2,"q":4,"k":0,"s":-5,"v":-2}},"shrivel":{"as":{"a":3,"c":2,"g":-2,"q":1,"k":7,"s":-15,"v":-1},"mg":{"a":4,"c":1,"g":2,"q":-1,"k":6,"s":45,"v":-9},"po":{"a":-2,"c":-1,"g":-1,"q":4,"k":3,"s":-31,"v":-1},"sl":{"a":-2,"c":2,"g":-2,"q":2,"k":5,"s":-3,"v":-2},"sv":{"a":2,"c":0,"g":8,"q":0,"k":8,"s":46,"v":-10},"tv":{"a":-2,"c":-2,"g":4,"q":2,"k":-1,"s":42,"v":-14},"tl":{"a":-2,"c":1,"g":-4,"q":0,"k":7,"s":13,"v":-10}},"wilting":{"as":{"a":-1,"c":2,"g":-2,"q":1,"k":3,"s":20,"v":-9},"mg":{"a":-1,"c":3,"g":6,"q":2,"k":-4,"s":38,"v":-8},"po":{"a":-1,"c":1,"g":-1,"q":4,"k":-2,"s":7,"v":-11},"sl":{"a":-3,"c":2,"g":3,"q":-3,"k":7,"s":22,"v":-12},"sv":{"a":1,"c":1,"g":0,"q":0,"k":-6,"s":-4,"v":-14},"tv":{"a":0,"c":0,"g":2,"q":4,"k":2,"s":54,"v":-6},"tl":{"a":-3,"c":1,"g":-1,"q":0,"k":5,"s":5,"v":-5}},"starting":12,"name":"Tedra#388"}
        ],
        vineyards: [
          {
            name: 'sample whatever extende extende extende extende extende extende extendeddddddd',
            grape: null,
            cursor: 0,
            states: [defaultState],
            steps: []
          }
        ],
        barrels: [
          { name: 'meh' }
        ],
        ux: {
          currentTab: 'vineyards',
          currentMain: null
        }
      };

      if (_.isNil(initialState.ux.currentMain)) {
        initialState.ux.currentMain = initialState[initialState.ux.currentTab][0].name;
      }

      function vineyardApp(state = initialState, action) {
        console.log(action.type, action);
        switch(action.type) {
          case 'CHANGE_STARTING_NUMBER':
          // Deprecated until I start doing grape modifying.
            return _.assign({}, state, {
              grapes: _.map(state.grapes, (grape) => {
                if (grape.name == action.grape) {
                  return _.assign({}, grape, { starting: action.starting });
                } else {
                  return _.assign({}, grape);
                }
              })
            });
          case 'UPDATE_VINEYARD_STATE':
            return _.assign({}, state, {
              vineyards: _.map(state.vineyards, (vineyard) => {
                if (vineyard.name == action.vineyard) {
                  let states = _.map(vineyard.states, _.identity);
                  states[action.index] = action.state
                  return _.assign({}, vineyard, { states });
                } else {
                  return vineyard;
                }
              })
            });
          case 'UPDATE_VINEYARD_ACTION':
            return _.assign({}, state, {
              vineyards: _.map(state.vineyards, (vineyard) => {
                if (vineyard.name == action.vineyard) {
                  let steps = _.map(vineyard.steps, _.identity);
                  if (_.isNil(steps[action.index])) {
                    steps[action.index] = {
                      step: action.index
                    }
                  }
                  steps[action.index].tend = action.action
                  return _.assign({}, vineyard, { steps });
                } else {
                  return vineyard;
                }
              })
            });
          case 'ADD_STATES':
            return _.assign({}, state, {
              vineyards: _.map(state.vineyards, (vineyard) => {
                if (vineyard.name == action.vineyard) {
                  let states = _.map(vineyard.states, _.identity);
                  if (states.length == 0) { states.push(defaultState); }
                  _(action.num).times(() => states.push(defaultState));
                  return _.assign({}, vineyard, { states });
                } else {
                  return vineyard;
                }
              })
            });
          case 'CHANGE_GRAPE':
            return _.assign({}, state, {
              vineyards: _.map(state.vineyards, (vineyard) => {
                if (vineyard.name == action.vineyard) {
                  return _.assign({}, vineyard, {
                    grape: action.grape,
                    steps: [{
                      tend: null,
                      acid: 0,
                      color: 0,
                      grapes: _.find(state.grapes, (_grape) => {
                        return _grape.name == action.grape;
                      }).starting,
                      quality: 0,
                      skin: 0,
                      sugar: 0,
                      vigor: 100,
                      step: 0
                    }]
                  });
                } else {
                  return _.assign({}, vineyard);
                }
              })
            });
          case 'UPDATE_VINEYARD_CURSOR':
            return _.assign({}, state, {
              vineyards: _.map(state.vineyards, (vineyard) => {
                if (vineyard.name == action.vineyard) {
                  return _.assign({}, vineyard, { cursor: action.cursor });
                } else {
                  return _.assign({}, vineyard);
                }
              })
            });
          case 'UPDATE_VINEYARD_CULTIVATION_STEPS':
            return _.assign({}, state, {
              vineyards: _.map(state.vineyards, (vineyard) => {
                if (vineyard.name == action.vineyard) {
                  return _.assign({}, vineyard, { steps: action.steps });
                } else {
                  return _.assign({}, vineyard);
                }
              })
            });
          case 'CHANGE_LISTING':
            return _.assign({}, state, {
              ux: _.assign({}, state.ux, {
                currentMain: action.listing
              })
            });
          case 'CHANGE_TAB':
            const main = (() => {
              if (action.main) {
                return action.main;
              }
              if (_.has(initialState, action.tab )) {
                return initialState[action.tab][0].name;
              }
              return null;
            })();
            return _.assign({}, state, {
              ux: _.assign({}, state.ux, {
                currentTab: action.tab,
                currentMain: main
              })
            });
          default: return state;
        }
      };
      let store = Redux.createStore(vineyardApp);

      const capitalize = (str) => str.charAt(0).toUpperCase() + str.slice(1);

      const changeListing = (listing) => {
        store.dispatch({ type: 'CHANGE_LISTING', listing });
      };

      const changeTab = (tab, main = null) => {
        store.dispatch({ type: 'CHANGE_TAB', tab, main });
      };

      const runVineyardCultivation = () => {
        const currState = store.getState();
        const currVineyard = _.find(currState.vineyards, (v) => {
          return v.name == currState.ux.currentMain;
        });

        if (_.isNil(currVineyard)) { return; }
        if (_.isNil(currVineyard.grape)) { return; }

        const vineyardGrape = _.find(currState.grapes, (g) => {
          return g.name == currVineyard.grape;
        });

        const stateMap = _.invert({
          'sagging': 'The vines are sagging a bit',
          'wilting': 'Leaves are wilting',
          'musty': 'A musty smell can be detected',
          'fat': 'Stems look especially fat',
          'rustle': 'Leaves rustle in the breeze',
          'shrivel': 'The grapes are starting to shrivel',
          'shimmer': 'Leaves shimmer with moisture'
        });

        const tendMap = _.invert({
          'as': 'Aerate the soil',
          'mg': 'Mist the grapes',
          'po': 'Pinch off the weakest stems',
          'sl': 'Shade the leaves',
          'sv': 'Spread out the vines',
          'tv': 'Tie the vines to the trellis',
          'tl': 'Trim the lower leaves'
        });

        const stepsUntilNilTend = (() => {
          const index = _.findIndex(currVineyard.steps, (vStep) => {
            return _.isNil(vStep.tend);
          })
          return index == -1 ? currVineyard.steps.length-1 : index;
        })() + 1;

        if (!_.isNil(_.last(currVineyard.steps).tend) &&
            stepsUntilNilTend >= Math.max(1, _.size(currVineyard.states))) {
          store.dispatch({ type: 'ADD_STATES', vineyard: currVineyard.name, num: 1 });
        }

        if (stepsUntilNilTend >= currVineyard.steps.length) {
          currVineyard.steps.push({ step: _.last(currVineyard.steps).step + 1 });
        }

        const cultivate = (previousStep, step) => {
          const tend = vineyardGrape[
            stateMap[currVineyard.states[previousStep.step]]
          ][
            tendMap[previousStep.tend]
          ];

          return {
            tend: step.tend,
            acid: Math.max(0, previousStep.acid + tend.a),
            color: Math.max(0, previousStep.color + tend.c),
            grapes: Math.max(0, previousStep.grapes + tend.g),
            quality: Math.max(0, previousStep.quality + tend.q),
            skin: Math.max(0, previousStep.skin + tend.k),
            sugar: Math.max(0, previousStep.sugar + tend.s),
            vigor: Math.max(0, previousStep.vigor + tend.v),
            step: step.step
          };
        };

        const steps = _.reduce(currVineyard.steps,
          (cultivation, step) => {
            if (_.isNil(step)) {
              cultivation.push({ step: _.last(cultivation).step + 1 });
              return cultivation;
            }

            if (step.step === 0) {
              cultivation.push(step);
              return cultivation;
            }

            const previousStep = _.last(cultivation);

            if (_.isNil(previousStep.tend)) {
              cultivation.push(step);
              return cultivation;
            }

            cultivation.push(cultivate(previousStep, step));

            return cultivation;
          }, []);

        store.dispatch({
          type: 'UPDATE_VINEYARD_CULTIVATION_STEPS',
          vineyard: currVineyard.name,
          steps
        });
      };

      class ListingComponent extends React.Component {
        render() {
          const handle = () => {
            this.props.changeListing(this.props.name);
          };

          const classes = classNames({
            listing: true,
            selected: this.props.name == this.props.ux.currentMain
          });

          return (<div
            className={classes}
            onClick={handle}
            title={this.props.name}>
            {this.props.name}
          </div>);
        }
      }
      const Listing = ReactRedux.connect(
        (state) => state,
        (dispatch) => { return {
          changeListing: (listing) => { store.dispatch({ type: 'CHANGE_LISTING', listing }); }
        }}
      )(ListingComponent);

      class VineyardListComponent extends React.Component {
        render() {
          const vineyards = this.props.vineyards.map((vineyard) => {
            return <Listing key={vineyard.name} {...vineyard} />
          });

          return (<div id="vineyard-list" className="sidebar">
            {vineyards}
            <div className="vineyard-listing listing new-listing">
              + create new
            </div>
          </div>);
        }
      }
      const VineyardList = ReactRedux.connect((state) => state)(VineyardListComponent);

      class CultivationStepComponent extends React.Component {
        constructor(props) {
          super(props);

          _.bindAll(this, [
            'updateState', 'updateAction',
            'setCursor'
          ]);
        }

        vineyardStates() {
          return [
            'The vines are sagging a bit',
            'Leaves are wilting',
            'A musty smell can be detected',
            'Stems look especially fat',
            'Leaves rustle in the breeze',
            'The grapes are starting to shrivel',
            'Leaves shimmer with moisture'
          ].map((state) => {
            return (<option key={state} selected={state == this.props.state}>
              {state}
            </option>);
          });
        }

        tendActions() {
          return [
            '',
            'Aerate the soil',
            'Mist the grapes',
            'Pinch off the weakest stems',
            'Shade the leaves',
            'Spread out the vines',
            'Tie the vines to the trellis',
            'Trim the lower leaves'
          ].map((action) => {
            return (<option key={action} selected={action == this.props.data.tend}>
              {action}
            </option>);
          });
        }

        updateState(evt) {
          this.props.updateState(
            this.props.vineyard,
            this.props.data.step,
            evt.target.value
          );
        }

        updateAction(evt) {
          this.props.updateAction(
            this.props.vineyard,
            this.props.data.step,
            evt.target.value
          );
        }

        setCursor(evt) {
          this.props.updateCursor(this.props.vineyard, this.props.data.step);
        }

        renderCursor() {
          return (<input
            type="radio" name="vineyard"
            checked={this.props.data.step == this.props.cursor}
            onClick={this.setCursor}
            value={this.props.data.step} />);
        }

        render() {
          return (<tr>
            <td><select onChange={this.updateState}>
              {this.vineyardStates()}
            </select></td>
            <td><select onChange={this.updateAction}>
              {this.tendActions()}
            </select></td>
            <td>&nbsp;</td>
            <td>{this.props.data.acid}</td>
            <td>{this.props.data.color}</td>
            <td>{this.props.data.grapes}</td>
            <td>{this.props.data.quality}</td>
            <td>{this.props.data.skin}</td>
            <td>{this.props.data.sugar}</td>
            <td>{this.props.data.vigor}</td>
            <td>{this.renderCursor()}</td>
          </tr>);
        }
      }
      const CultivationStep = ReactRedux.connect(
        (state) => state,
        (dispatch) => { return {
          updateState: (vineyard, index, state) => {
            store.dispatch({ type: 'UPDATE_VINEYARD_STATE', vineyard, index, state });
            runVineyardCultivation();
          },
          updateAction: (vineyard, index, action) => {
            store.dispatch({ type: 'UPDATE_VINEYARD_ACTION', vineyard, index, action });
            runVineyardCultivation();
          },
          updateCursor: (vineyard, cursor) => {
            store.dispatch({ type: 'UPDATE_VINEYARD_CURSOR', vineyard, cursor });
          }
        }}
      )(CultivationStepComponent);

      class VineyardComponent extends React.Component {
        constructor(props) {
          super(props);
        }

        addMoreSteps(num) {
          this.props.addStates(this.props.vineyard.name, num)
        }

        renderAddMoreSteps() {
          const buttons = [ 1, 5, 10 ].map((num) => {
            return (<button key={num} onClick={() => this.addMoreSteps(num)}>
              +{num}
            </button>);
          });
          return (<tr>
            <td>
              {buttons}
            </td>
          </tr>);
        }

        render() {
          const cultivationSteps = (this.props.vineyard.states || [defaultState]).
            map((state, index) => {
              const step = this.props.vineyard.steps[index] || { step: index };
              return <CultivationStep
                key={index} vineyard={this.props.vineyard.name}
                cursor={this.props.vineyard.cursor}
                state={state} data={step} />
            });

          return (<table className="vineyard">
            <thead><tr>
              <th>State</th>
              <th>Action to Take</th>
              <th>&nbsp;</th>
              <th>Acid</th>
              <th>Color</th>
              <th>Grapes</th>
              <th>Quality</th>
              <th>Skin</th>
              <th>Sugar</th>
              <th>Vigor</th>
            </tr></thead>
            <tbody>
              {cultivationSteps}
              {this.renderAddMoreSteps()}
            </tbody>
          </table>);
        }
      }
      const Vineyard = ReactRedux.connect(
        (state) => state,
        (dispatch) => { return {
          addStates: (vineyard, num) => {
            store.dispatch({ type: 'ADD_STATES', vineyard, num });
          }
        }}
      )(VineyardComponent);

      class VineyardDesignerComponent extends React.Component {
        constructor(props) {
          super(props);

          _.bindAll(this, [
            'changeGrape', 'showDetails'
          ]);
        }

        changeGrape(evt) {
          this.props.changeGrape(this.vineyard.name, evt.target.value);
        }

        grapeList() {
          return this.props.grapes.map((grape) => {
            return <option key={grape.name}>
              {grape.name}
            </option>
          });
        }

        showDetails(evt) {
          changeTab('grapes', this.vineyard.grape);
        }

        render() {
          this.vineyard = _.find(this.props.vineyards, (vineyard) => {
            return vineyard.name == this.props.vineyard;
          });

          const grapeDetail = (() => {
            if (_.isNil(this.vineyard.grape)) { return; }
            return (<span
              className="show-grape-detail"
              onClick={this.showDetails}>(details)
            </span>);
          })();

          return (<div id="vineyard-main" className="main">
            <div>Name: <input type="text" value={this.vineyard.name} /></div>
            <div>Grape:
              <select onChange={this.changeGrape}>
                <option></option>
                {this.grapeList()}
              </select>
              {grapeDetail}
            </div>
            <div>Strategy: <select><option>Custom</option></select></div>

            <Vineyard vineyard={this.vineyard} />
          </div>);
        }
      }
      const VineyardDesign = ReactRedux.connect(
        (state) => state,
        (dispatch) => { return {
          changeGrape: (vineyard, grape) => {
            store.dispatch({ type: 'CHANGE_GRAPE', vineyard, grape });
          }
        }}
      )(VineyardDesignerComponent);

      class VineyardViewComponent extends React.Component {
        constructor(props) {
          super(props);

          if (_.isNil(this.props.ux.currentMain)) {
            this.props.changeListing(this.props.vineyards[0].name);
          }
        }

        render() {
          return(<div id="vineyard-view" className="view">
            <VineyardList />
            <VineyardDesign vineyard={this.props.ux.currentMain} />
          </div>);
        }
      }
      const VineyardView = ReactRedux.connect(
        (state) => state,
        (dispatch) => { return {
          changeListing
        }}
      )(VineyardViewComponent);

      class GrapeListComponent extends React.Component {
        render() {
          const grapes = this.props.grapes.map((grape) => {
            return <Listing key={grape.name} {...grape} />
          });

          return (<div id="grape-list" className="sidebar">
            {grapes}
            <div className="grape-listing listing new-listing">
              + create new
            </div>
          </div>);
        }
      }
      const GrapeList = ReactRedux.connect((state) => state)(GrapeListComponent);

      class TendTable extends React.Component {
        header() {
          const map = {
            'sagging': 'The vines are sagging a bit',
            'wilting': 'Leaves are wilting',
            'musty': 'A musty smell can be detected',
            'fat': 'Stems look especially fat',
            'rustle': 'Leaves rustle in the breeze',
            'shrivel': 'The grapes are starting to shrivel',
            'shimmer': 'Leaves shimmer with moisture'
          }[this.props.state];
          return (<div className="tend-table-header">
            {capitalize(this.props.state)}: ({map})
          </div>);
        }

        tendAction(abbrev) {
          return {
            'as': 'Aerate the soil',
            'mg': 'Mist the grapes',
            'po': 'Pinch off the weakest stems',
            'sl': 'Shade the leaves',
            'sv': 'Spread out the vines',
            'tv': 'Tie the vines to the trellis',
            'tl': 'Trim the lower leaves'
          }[abbrev];
        }

        renderTend(tend) {
          const data = this.props.data[this.props.state][tend];

          return (<tr key={tend}>
            <td>{this.tendAction(tend)}</td>
            <td>&nbsp;</td>
            <td>{data.a}</td>
            <td>{data.c}</td>
            <td>{data.g}</td>
            <td>{data.q}</td>
            <td>{data.k}</td>
            <td>{data.s}</td>
            <td>{data.v}</td>
          </tr>);
        }

        render() {
          const data = ['as', 'mg', 'po', 'sl', 'sv', 'tv', 'tl'].map((tend) => {
            return this.renderTend(tend);
          });

          return (<div className="tend-table">
            {this.header()}
            <table>
              <thead><tr>
                <th>Tending Action</th>
                <th>&nbsp;</th>
                <th>Acid</th>
                <th>Color</th>
                <th>Grapes</th>
                <th>Quality</th>
                <th>Skin</th>
                <th>Sugar</th>
                <th>Vigor</th>
              </tr></thead>
              <tbody>
                {data}
              </tbody>
            </table>
          </div>);
        }
      }

      class GrapeDesignerComponent extends React.Component {
        constructor(props) {
          super(props);

          _.bindAll(this, [
            'changeStartingNumber'
          ]);
        }

        changeStartingNumber(evt) {
          this.props.changeStartingNumber(this.grape.name, evt.target.valueAsNumber);
        }

        render() {
          this.grape = _.find(this.props.grapes, (grape) => {
            return grape.name == this.props.grape;
          });

          const tendTables =
            ['sagging', 'wilting', 'musty', 'fat', 'rustle', 'shrivel', 'shimmer'].map(
            (state) => {
              return <TendTable key={state} state={state} data={this.grape} />
            });

          return (<div id="grape-main" className="main">
            <div>Name: <input type="text" /></div>
            <div>URL: <input type="text" /></div>
            <div>Starting Grapes:
              <input
              type="number" min="0" step="1"
              onChange={this.changeStartingNumber}
              value={this.grape.starting} />
            </div>

            {tendTables}
          </div>);
        }
      }
      const GrapeDesign = ReactRedux.connect(
        (state) => state,
        (dispatch) => { return {
          changeListing,
          changeStartingNumber: (grape, starting) => {
            store.dispatch({ type: 'CHANGE_STARTING_NUMBER', grape, starting });
          }
        }}
      )(GrapeDesignerComponent);

      class GrapeViewComponent extends React.Component {
        constructor(props) {
          super(props);

          if (_.isNil(this.props.ux.currentMain)) {
            this.props.changeListing(this.props.grapes[0].name);
          }
        }

        render() {
          return(<div id="grape-view" className="view">
            <GrapeList />
            <GrapeDesign grape={this.props.ux.currentMain} />
          </div>);
        }
      }
      const GrapeView = ReactRedux.connect(
        (state) => state,
        (dispatch) => { return {
          changeListing
        }}
      )(GrapeViewComponent);

      class BarrelView extends React.Component {
        render() {
          return <div>LOL have not even started</div>;
        }
      }

      class HelpView extends React.Component {
        render() {
          return (<div className="view">
            Something about how to use stuff, plus a bunch of guides.
          </div>);
        }
      }

      class AboutView extends React.Component {
        render() {
          return (<div className="view">
            Blah blah blah.
          </div>);
        }
      }

      class ApplicationComponent extends React.Component {
        render() {
          const renderTab = (tab) => {
            const key = tab.toLowerCase();
            const handle = () => { this.props.changeTab(key); };
            const classes = classNames({ tab: true, selected: this.props.ux.currentTab == key });
            return (<div key={key} className={classes} onClick={handle}>
              {tab}
            </div>);
          };

          const tabs = [ 'Barrels', 'Vineyards', 'Grapes' ].map(renderTab);
          const infos = [ 'Help', 'About' ].map(renderTab);

          const view = {
            'barrels': () => <BarrelView />,
            'grapes': () => <GrapeView />,
            'vineyards': () => <VineyardView />,
            'help': () => <HelpView />,
            'about': () => <AboutView />,
          }[this.props.ux.currentTab]();

          return(<div id="app">
            <div id="header">
              Manage:
              {tabs}
              <div id="header-info">Info:</div>
              {infos}
            </div>
            {view}
          </div>);
        }
      }
      const Application = ReactRedux.connect(
        (state) => state,
        (dispatch) => { return {
          changeTab
        }}
      )(ApplicationComponent);

      ReactDOM.render(
        <ReactRedux.Provider store={store}>
          <Application />
        </ReactRedux.Provider> ,
        document.getElementById('root')
      );
    </script>
  </body>
</html>
