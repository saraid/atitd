<html>
  <head>
    <meta charset="UTF-8" />
    <link rel="shortcut icon" type="image/x-icon" href="/atitd/favicon.ico">
    <title>ATITD Vinter</title>
    <script src="https://unpkg.com/react@16.2.0/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@16.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/lodash@4.17.4/lodash.min.js"></script>
    <script src="https://unpkg.com/redux@3.7.2/dist/redux.min.js"></script>
    <script src="https://unpkg.com/react-redux@5.0.6/dist/react-redux.min.js"></script>
    <script src="https://unpkg.com/classnames@2.2.5/index.js"></script>
    <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
    <style type="text/css">
      #app {
        height: 100%;
      }

      #console {
        position: fixed;
        top: 5px;
        right: 10px;
      }

      #header {
        width: 100%;
        border-bottom: solid 1px black;
      }

      #header .tab {
        display: inline-block;
        margin-left: 1em;
        padding: 0.3em;
        border: solid 1px black;
        border-bottom: 0;
        cursor: pointer;
      }

      #header .tab.selected {
        background-color: lightblue;
      }

      #header #header-info {
        display: inline-block;
        margin-left: 1em;
      }

      .view {
        min-height: 100%;
        width: 100%;
        display: flex;
      }

      .sidebar {
        width: 15em;
        background-color: lightgray;
      }

      .listing {
        padding: 0.4em;
        border-bottom: dotted 1px darkgray;
        cursor: pointer;
        overflow: hidden;
      }

      .listing:hover {
        font-weight: bold;
      }

      .listing.selected {
        background-color: lightblue;
      }

      .listing .listing-options {
        float: right;
      }

      .main {
        padding: 0.5em;
      }

      .vineyard {
        margin-top: 1.5em;
      }

      .information {
        display: flex;
        justify-content: space-between;
      }

      #vineyard-main .vineyard-information .vineyard-meta select.flavor {
        width: 6em;
      }

      .show-grape-detail {
        display: inline-block;
        margin-left: 0.5em;
        cursor: pointer;
      }

      .tend-table {
        margin-top: 1.5em;
      }

      .tend-table .tend-table-header {
        font-size: 110%;
        font-weight: bold;
        border-bottom: solid 1px black;
      }

      #grape-main input[type="number"] {
        width: 40px;
      }
    </style>
  </head>
  <body>
    <div id="console">
      <button onClick="saveToLocalStorage()">Save</button>
      <button onClick="clearLocalStorage()">Purge</button>
    </div>
    <div id="root"></div>
    <script type="text/babel">
      const defaultState = 'The vines are sagging a bit';
      const localStorageKey = 'atitd-vinter';

      const saveToLocalStorage = () => {
        let serializedData = {};

        const state = store.getState();

        // Grapes
        serializedData.grapes = state.grapes.map((grape) => {
          return _.omit(grape, 'id');
        });

        // Vineyards
        serializedData.vineyards = state.vineyards.map((vineyard) => {
          if (vineyard.grape) {
            const serializedVineyard = _.assign({}, vineyard, {
              grape: _.find(state.grapes, (grape) => {
                return vineyard.grape == grape.id;
              }).name
            });
            return _.omit(serializedVineyard, 'id');
          } else {
            return _.omit(vineyard, 'id');
          }
        });

        // Barrels
        // ...

        window.localStorage.setItem(localStorageKey, JSON.stringify(serializedData));
      };

      const loadFromLocalStorage = () => {
        let data = JSON.parse(window.localStorage.getItem(localStorageKey));
        if (_.isNil(data)) {
          return undefined;
        }

        // Grapes
        data.grapes = data.grapes.map(
          (grape) => _.assign({}, grape, { id: _.uniqueId('grape') })
        );

        // Vineyards
        data.vineyards = data.vineyards.map((vineyard) => {
          let deserialized = _.assign({}, vineyard, { id: _.uniqueId('vineyard') })
          if (deserialized.grape) {
            deserialized.grape =
              _.find(data.grapes, (grape) => grape.name == vineyard.grape).id;
          }
          return deserialized;
        });

        // Barrels
        // ...

        return data;
      };

      const clearLocalStorage = () => {
        window.localStorage.removeItem(localStorageKey);
      };

      let initialState = {
        grapes: [
          {"fat":{"as":{"a":2,"c":6,"g":7,"q":1,"k":-9,"s":-2,"v":-2},"mg":{"a":1,"c":4,"g":3,"q":3,"k":11,"s":-2,"v":-4},"po":{"a":2,"c":3,"g":4,"q":1,"k":15,"s":-3,"v":-6},"sl":{"a":-5,"c":8,"g":3,"q":-2,"k":16,"s":0,"v":-12},"sv":{"a":1,"c":-4,"g":-6,"q":-2,"k":12,"s":4,"v":-14},"tv":{"a":4,"c":2,"g":0,"q":1,"k":-6,"s":0,"v":-3},"tl":{"a":5,"c":-1,"g":-2,"q":3,"k":9,"s":-2,"v":-12}},"musty":{"as":{"a":1,"c":2,"g":2,"q":-3,"k":15,"s":1,"v":-5},"mg":{"a":6,"c":2,"g":3,"q":3,"k":7,"s":3,"v":-14},"po":{"a":5,"c":6,"g":5,"q":1,"k":-1,"s":2,"v":-12},"sl":{"a":7,"c":8,"g":-5,"q":1,"k":15,"s":1,"v":-9},"sv":{"a":8,"c":4,"g":6,"q":0,"k":8,"s":4,"v":-6},"tv":{"a":0,"c":4,"g":-6,"q":-1,"k":-11,"s":2,"v":-8},"tl":{"a":8,"c":-2,"g":-3,"q":0,"k":-11,"s":-2,"v":-3}},"rustle":{"as":{"a":4,"c":4,"g":-5,"q":0,"k":6,"s":2,"v":-9},"mg":{"a":7,"c":-3,"g":6,"q":3,"k":5,"s":1,"v":-6},"po":{"a":5,"c":-6,"g":2,"q":3,"k":16,"s":-2,"v":-1},"sl":{"a":0,"c":8,"g":1,"q":1,"k":13,"s":2,"v":-11},"sv":{"a":6,"c":-4,"g":-5,"q":-3,"k":-11,"s":-1,"v":-4},"tv":{"a":-5,"c":0,"g":-6,"q":-2,"k":8,"s":-2,"v":-4},"tl":{"a":7,"c":1,"g":-5,"q":-3,"k":14,"s":0,"v":-5}},"sagging":{"as":{"a":4,"c":-2,"g":1,"q":0,"k":-8,"s":2,"v":-10},"mg":{"a":2,"c":-3,"g":2,"q":-3,"k":14,"s":0,"v":-5},"po":{"a":3,"c":-6,"g":-4,"q":1,"k":1,"s":3,"v":-9},"sl":{"a":-6,"c":2,"g":7,"q":4,"k":-6,"s":4,"v":-10},"sv":{"a":-6,"c":-1,"g":-4,"q":1,"k":5,"s":-3,"v":-10},"tv":{"a":-2,"c":6,"g":3,"q":2,"k":6,"s":3,"v":-10},"tl":{"a":-6,"c":4,"g":0,"q":1,"k":6,"s":-2,"v":-7}},"shimmer":{"as":{"a":-6,"c":0,"g":-2,"q":1,"k":4,"s":3,"v":-1},"mg":{"a":-4,"c":-3,"g":2,"q":-1,"k":5,"s":-1,"v":-9},"po":{"a":2,"c":8,"g":-1,"q":4,"k":-3,"s":-3,"v":-1},"sl":{"a":-5,"c":-1,"g":-2,"q":2,"k":-11,"s":-2,"v":-2},"sv":{"a":-3,"c":6,"g":8,"q":0,"k":11,"s":-3,"v":-10},"tv":{"a":0,"c":1,"g":4,"q":2,"k":-9,"s":0,"v":-14},"tl":{"a":3,"c":-4,"g":-4,"q":0,"k":4,"s":-2,"v":-10}},"shrivel":{"as":{"a":6,"c":-5,"g":2,"q":4,"k":9,"s":3,"v":-7},"mg":{"a":-2,"c":1,"g":-4,"q":-3,"k":-12,"s":-3,"v":-13},"po":{"a":-2,"c":4,"g":-3,"q":-1,"k":3,"s":4,"v":-6},"sl":{"a":8,"c":-3,"g":4,"q":3,"k":14,"s":1,"v":-6},"sv":{"a":5,"c":-2,"g":7,"q":4,"k":16,"s":2,"v":-9},"tv":{"a":-2,"c":4,"g":-6,"q":2,"k":1,"s":2,"v":-12},"tl":{"a":-4,"c":-1,"g":2,"q":4,"k":-1,"s":-1,"v":-2}},"wilting":{"as":{"a":-2,"c":5,"g":-2,"q":1,"k":4,"s":4,"v":-9},"mg":{"a":3,"c":5,"g":6,"q":2,"k":-2,"s":2,"v":-8},"po":{"a":2,"c":2,"g":-1,"q":4,"k":-7,"s":-3,"v":-11},"sl":{"a":-3,"c":3,"g":3,"q":-3,"k":-11,"s":0,"v":-12},"sv":{"a":8,"c":8,"g":0,"q":0,"k":10,"s":-1,"v":-14},"tv":{"a":5,"c":8,"g":2,"q":4,"k":8,"s":4,"v":-6},"tl":{"a":4,"c":5,"g":-1,"q":0,"k":13,"s":4,"v":-5}},"starting":11,"name":"Pascalito#356","id":_.uniqueId('grape')},
{"fat":{"as":{"a":4,"c":-1,"g":7,"q":1,"k":8,"s":-39,"v":-2},"mg":{"a":4,"c":-3,"g":3,"q":3,"k":6,"s":-23,"v":-4},"po":{"a":2,"c":3,"g":4,"q":1,"k":5,"s":36,"v":-6},"sl":{"a":0,"c":3,"g":3,"q":-2,"k":1,"s":3,"v":-12},"sv":{"a":-2,"c":4,"g":-6,"q":-2,"k":-6,"s":43,"v":-14},"tv":{"a":1,"c":3,"g":0,"q":1,"k":-5,"s":15,"v":-3},"tl":{"a":0,"c":4,"g":-2,"q":3,"k":5,"s":11,"v":-12}},"musty":{"as":{"a":3,"c":-3,"g":2,"q":-1,"k":3,"s":-16,"v":-5},"mg":{"a":4,"c":-1,"g":3,"q":3,"k":0,"s":1,"v":-14},"po":{"a":0,"c":2,"g":5,"q":1,"k":-1,"s":-31,"v":-12},"sl":{"a":4,"c":1,"g":-5,"q":1,"k":-3,"s":55,"v":-9},"sv":{"a":3,"c":4,"g":6,"q":0,"k":3,"s":32,"v":-6},"tv":{"a":4,"c":0,"g":-6,"q":-1,"k":-2,"s":24,"v":-8},"tl":{"a":-1,"c":3,"g":-3,"q":0,"k":4,"s":21,"v":-3}},"rustle":{"as":{"a":4,"c":0,"g":-5,"q":0,"k":3,"s":33,"v":-9},"mg":{"a":4,"c":4,"g":6,"q":3,"k":-6,"s":34,"v":-6},"po":{"a":0,"c":0,"g":2,"q":3,"k":-5,"s":49,"v":-1},"sl":{"a":2,"c":-1,"g":1,"q":1,"k":8,"s":15,"v":-11},"sv":{"a":-2,"c":3,"g":-5,"q":-3,"k":-2,"s":-6,"v":-4},"tv":{"a":2,"c":1,"g":-6,"q":-2,"k":5,"s":46,"v":-4},"tl":{"a":-1,"c":1,"g":-5,"q":-3,"k":7,"s":-5,"v":-5}},"sagging":{"as":{"a":-3,"c":0,"g":1,"q":0,"k":7,"s":13,"v":-10},"mg":{"a":1,"c":-2,"g":2,"q":-3,"k":-5,"s":55,"v":-5},"po":{"a":2,"c":3,"g":-4,"q":1,"k":-1,"s":-37,"v":-9},"sl":{"a":-3,"c":2,"g":7,"q":4,"k":2,"s":40,"v":-10},"sv":{"a":0,"c":4,"g":-4,"q":1,"k":-1,"s":5,"v":-10},"tv":{"a":1,"c":3,"g":3,"q":2,"k":-3,"s":8,"v":-10},"tl":{"a":-3,"c":0,"g":0,"q":1,"k":-3,"s":41,"v":-7}},"shimmer":{"as":{"a":2,"c":3,"g":2,"q":4,"k":6,"s":5,"v":-7},"mg":{"a":4,"c":3,"g":-4,"q":-3,"k":1,"s":51,"v":-13},"po":{"a":3,"c":4,"g":-3,"q":-1,"k":8,"s":13,"v":-6},"sl":{"a":-1,"c":2,"g":4,"q":3,"k":-5,"s":52,"v":-6},"sv":{"a":-2,"c":2,"g":7,"q":4,"k":5,"s":31,"v":-9},"tv":{"a":4,"c":2,"g":-6,"q":2,"k":-2,"s":31,"v":-12},"tl":{"a":4,"c":-3,"g":2,"q":4,"k":0,"s":-5,"v":-2}},"shrivel":{"as":{"a":3,"c":2,"g":-2,"q":1,"k":7,"s":-15,"v":-1},"mg":{"a":4,"c":1,"g":2,"q":-1,"k":6,"s":45,"v":-9},"po":{"a":-2,"c":-1,"g":-1,"q":4,"k":3,"s":-31,"v":-1},"sl":{"a":-2,"c":2,"g":-2,"q":2,"k":5,"s":-3,"v":-2},"sv":{"a":2,"c":0,"g":8,"q":0,"k":8,"s":46,"v":-10},"tv":{"a":-2,"c":-2,"g":4,"q":2,"k":-1,"s":42,"v":-14},"tl":{"a":-2,"c":1,"g":-4,"q":0,"k":7,"s":13,"v":-10}},"wilting":{"as":{"a":-1,"c":2,"g":-2,"q":1,"k":3,"s":20,"v":-9},"mg":{"a":-1,"c":3,"g":6,"q":2,"k":-4,"s":38,"v":-8},"po":{"a":-1,"c":1,"g":-1,"q":4,"k":-2,"s":7,"v":-11},"sl":{"a":-3,"c":2,"g":3,"q":-3,"k":7,"s":22,"v":-12},"sv":{"a":1,"c":1,"g":0,"q":0,"k":-6,"s":-4,"v":-14},"tv":{"a":0,"c":0,"g":2,"q":4,"k":2,"s":54,"v":-6},"tl":{"a":-3,"c":1,"g":-1,"q":0,"k":5,"s":5,"v":-5}},"starting":12,"name":"Tedra#388","id":_.uniqueId('grape')}
        ],
        vineyards: [
          {
            id: _.uniqueId('vineyard'),
            name: 'sample whatever extende extende extende extende extende extende extendeddddddd',
            grape: null,
            cursor: 0,
            states: [defaultState],
            steps: []
          }
        ],
        barrels: [
          { name: 'meh' }
        ],
        ux: {
          currentTab: 'vineyards',
          currentMain: null
        }
      };

      const fromLocalStorage = loadFromLocalStorage();

      if (fromLocalStorage) {
        initialState.grapes = fromLocalStorage.grapes;
        initialState.vineyards = fromLocalStorage.vineyards;
        //initialState.barrels = fromLocalStorage.barrels;
      }

      if (_.isNil(initialState.ux.currentMain) &&
          _.has(initialState, initialState.ux.currentTab)) {
        initialState.ux.currentMain = initialState[initialState.ux.currentTab][0].id;
      }

      const vineyardStrategies = [
        {
          name: 'Minimum Loss of Vigor',
          evaluate: (state, grape) => {
            return _.maxBy(_.keys(grape[state]), (tend) => grape[state][tend].v);
          }
        },
        {
          name: 'Maximum Gain of Grapes',
          evaluate: (state, grape) => {
            return _.maxBy(_.keys(grape[state]),
              (tend) => (grape[state][tend].g * 100) + grape[state][tend].v
            );
          }
        },
        {
          name: 'Maximum Gain of Sugar',
          evaluate: (state, grape) => {
            return _.maxBy(_.keys(grape[state]),
              (tend) => (grape[state][tend].s * 100) + grape[state][tend].v
            );
          }
        },
        {
          name: 'Maximum Gain of Color * Skin (Tannin)',
          evaluate: (state, grape) => {
            return _.maxBy(_.keys(grape[state]),
              (tend) => grape[state][tend].c * grape[state][tend].k
            );
          }
        }
      ];

      const vineyardFlavors = [
        '',
        "Acetaldehyde","Acetic Acid","Almond","Apple","Apricot","Artichoke",
        "Artificial Fruit","Asparagus","Banana","Bell Pepper","Black Olives",
        "Black Pepper","Blackberry","Burnt Matches","Burnt Toast","Buteric Acid",
        "Butter","Butterscotch","Cabbage","Cassis","Cedar","Cherry","Chocolate",
        "Cloves","Coffee","Diesel","Dust","Ethanol","Ethyl Acetate","Eucalyptus",
        "Fig","Filter Pads","Fish","Flor Yeast","Fusel Alcohol","Garlic",
        "Geraniums","Grapefruit","Grass","Green Beans","Green Olives","Hazelnut",
        "Honey","Horsey Smells","Hot Alcohol","Hydrogen Sulfide","Kerosene","Leesy",
        "Lemon","Licorice","Linalool","Melon","Menthol","Mercaptan",
        "Methyl Anthranilate","Mildew","Mint","Molasses","Moldy Cork",
        "Mousey Smells","Mushrooms","Oak","Orange Blossoms","Peach","Pineapple",
        "Plastic","Prune","Raisin","Raspberry","Roses","Rubber","Sauerkraut",
        "Sharp Sulfur","Skunk","Smoke","Soap","Sorbate","Soy Sauce","Stemmy",
        "Straw","Strawberry","Strawberry Jam","Sweat","Tar","Tea","Tobacco",
        "Vanilla","Violets","Walnut","Wet Cardboard","Wet Wool"
      ];

      function vineyardApp(state = initialState, action) {
        console.log(action.type, action);
        switch(action.type) {
          case 'UPDATE_VINEYARD_STATE':
            return _.assign({}, state, {
              vineyards: _.map(state.vineyards, (vineyard) => {
                if (vineyard.id == action.vineyard) {
                  let states = _.map(vineyard.states, _.identity);
                  states[action.index] = action.state
                  return _.assign({}, vineyard, { states });
                } else {
                  return vineyard;
                }
              })
            });
          case 'UPDATE_VINEYARD_ACTION':
            return _.assign({}, state, {
              vineyards: _.map(state.vineyards, (vineyard) => {
                if (vineyard.id == action.vineyard) {
                  let steps = _.map(vineyard.steps, _.identity);
                  if (_.isNil(steps[action.index])) {
                    steps[action.index] = {
                      step: action.index
                    }
                  }
                  steps[action.index].tend = action.action
                  return _.assign({}, vineyard, { steps });
                } else {
                  return vineyard;
                }
              })
            });
          case 'ADD_STATES':
            return _.assign({}, state, {
              vineyards: _.map(state.vineyards, (vineyard) => {
                if (vineyard.id == action.vineyard) {
                  let states = _.map(vineyard.states, _.identity);
                  if (states.length == 0) { states.push(defaultState); }
                  _(action.num).times(() => states.push(defaultState));
                  return _.assign({}, vineyard, { states });
                } else {
                  return vineyard;
                }
              })
            });
          case 'UPDATE_VINEYARD_GRAPE':
            return _.assign({}, state, {
              vineyards: _.map(state.vineyards, (vineyard) => {
                if (vineyard.id == action.vineyard) {
                  return _.assign({}, vineyard, {
                    grape: action.grape,
                    steps: [{
                      tend: null,
                      acid: 0,
                      color: 0,
                      grapes: _.find(state.grapes, (_grape) => {
                        return _grape.id == action.grape;
                      }).starting,
                      quality: 0,
                      skin: 0,
                      sugar: 0,
                      vigor: 100,
                      step: 0
                    }]
                  });
                } else {
                  return _.assign({}, vineyard);
                }
              })
            });
          case 'CLEAR_VINEYARD_ACTIONS':
            return _.assign({}, state, {
              vineyards: _.map(state.vineyards, (vineyard) => {
                if (vineyard.id == action.vineyard) {
                  return _.assign({}, vineyard, {
                    steps: _.map(vineyard.steps, (step) => {
                      return _.assign({}, step, { tend: null });
                    })
                  });
                } else {
                  return _.assign({}, vineyard);
                }
              })
            });
          case 'UPDATE_VINEYARD_STRATEGY':
            return _.assign({}, state, {
              vineyards: _.map(state.vineyards, (vineyard) => {
                if (vineyard.id == action.vineyard) {
                  return _.assign({}, vineyard, {
                    steps: _.map(vineyard.steps, (step) => {
                      return _.assign({}, step, { tend: null });
                    }),
                    strategy: action.strategy == 'Custom' ? null : action.strategy
                  });
                } else {
                  return _.assign({}, vineyard);
                }
              })
            });
          case 'UPDATE_VINEYARD_META':
            return _.assign({}, state, {
              vineyards: _.map(state.vineyards, (vineyard) => {
                if (vineyard.id == action.vineyard) {
                  return _.assign({}, vineyard, { meta: action.meta });
                } else {
                  return _.assign({}, vineyard);
                }
              })
            });
          case 'UPDATE_VINEYARD_NAME':
            return _.assign({}, state, {
              vineyards: _.map(state.vineyards, (vineyard) => {
                if (vineyard.id == action.vineyard) {
                  return _.assign({}, vineyard, { name: action.name });
                } else {
                  return _.assign({}, vineyard);
                }
              })
            });
          case 'UPDATE_VINEYARD_CURSOR':
            return _.assign({}, state, {
              vineyards: _.map(state.vineyards, (vineyard) => {
                if (vineyard.id == action.vineyard) {
                  return _.assign({}, vineyard, { cursor: action.cursor });
                } else {
                  return _.assign({}, vineyard);
                }
              })
            });
          case 'UPDATE_VINEYARD_CULTIVATION_STEPS':
            return _.assign({}, state, {
              vineyards: _.map(state.vineyards, (vineyard) => {
                if (vineyard.id == action.vineyard) {
                  return _.assign({}, vineyard, { steps: action.steps });
                } else {
                  return _.assign({}, vineyard);
                }
              })
            });
          case 'UPDATE_GRAPE_NUMBER':
            return _.assign({}, state, {
              grapes: _.map(state.grapes, (grape) => {
                if (grape.id == action.grape) {
                  let clone = _.clone(grape)
                  _.set(clone, action.path, action.num);
                  return clone;
                } else {
                  return _.assign({}, grape);
                }
              })
            });
          case 'UPDATE_GRAPE_STARTING':
            return _.assign({}, state, {
              grapes: _.map(state.grapes, (grape) => {
                if (grape.id == action.grape) {
                  return _.assign({}, grape, { starting: action.starting });
                } else {
                  return _.assign({}, grape);
                }
              })
            });
          case 'UPDATE_GRAPE_META':
            return _.assign({}, state, {
              grapes: _.map(state.grapes, (grape) => {
                if (grape.id == action.grape) {
                  return _.assign({}, grape, { meta: action.meta });
                } else {
                  return _.assign({}, grape);
                }
              })
            });
          case 'UPDATE_GRAPE_NAME':
            return _.assign({}, state, {
              grapes: _.map(state.grapes, (grape) => {
                if (grape.id == action.grape) {
                  return _.assign({}, grape, { name: action.name });
                } else {
                  return _.assign({}, grape);
                }
              })
            });
          case 'CHANGE_LISTING':
            return _.assign({}, state, {
              ux: _.assign({}, state.ux, {
                currentMain: action.listing
              })
            });
          case 'CREATE_LISTING':
            return _.tap(_.assign({}, state, {
              [state.ux.currentTab]: _.tap(
                _.map(state[state.ux.currentTab], _.identity),
                (listings) => listings.push(generateListing(state.ux.currentTab))
              )
            }), (newState) => {
              _.assign(newState, {
                ux: _.assign(newState.ux, {
                  currentMain: _.last(newState[state.ux.currentTab]).id
                })
              });
            });
          case 'REORDER_LISTING':
            return (() => {
              let clone = _.map(state[state.ux.currentTab], _.identity);
              const index = _.findIndex(clone, (listing) => listing.id == action.id);
              if (index >= 0) {
                const mover = clone.splice(index, 1)[0];
                clone.splice(action.index, 0, mover);
              }
              return _.assign({}, state, { [state.ux.currentTab]: clone });
            })();
          case 'REMOVE_LISTING':
            return (() => {
              let clone = _.map(state[state.ux.currentTab], _.identity);
              let currentMain = state.ux.currentMain;
              const index = _.findIndex(clone, (listing) => listing.id == action.id);
              if (index >= 0) {
                if (clone.splice(index, 1).id == state.ux.currentMain) {
                  currentMain = clone[0].id;
                }
              }
              return _.assign({}, state, {
                [state.ux.currentTab]: clone,
                ux: _.assign({}, state.ux, { currentMain })
              });
            })();
          case 'CHANGE_TAB':
            const main = (() => {
              if (action.main) {
                return action.main;
              }
              if (_.has(initialState, action.tab )) {
                return initialState[action.tab][0].id;
              }
              return null;
            })();
            return _.assign({}, state, {
              ux: _.assign({}, state.ux, {
                currentTab: action.tab,
                currentMain: main
              })
            });
          default: return state;
        }
      };
      let store = Redux.createStore(vineyardApp);

      const capitalize = (str) => str.charAt(0).toUpperCase() + str.slice(1);

      const changeListing = (listing) => {
        store.dispatch({ type: 'CHANGE_LISTING', listing });
      };

      const createListing = () => {
        store.dispatch({ type: 'CREATE_LISTING' });
      };

      const generateListing = (type) => {
        switch (type) {
          case 'vineyards':
            return {
              id: _.uniqueId('vineyard'),
              name: 'New Vineyard',
              grape: null,
              cursor: 0,
              states: [defaultState],
              steps: []
            };
          case 'grapes':
            const character = {"a":0,"c":-0,"g":0,"q":0,"k":0,"s":-0,"v":-0};
            const tend = [ "as","mg","po","sl","sv","tv","tl" ];
            const states =
              ["fat","musty","rustle","sagging","shimmer","shrivel","wilting"];

            let newGrape = {"starting":10,"name":"New Grape","id":_.uniqueId('grape')};

            states.forEach((state) => {
              _.assign(newGrape, {
                [state]: _.zipObject(tend, _(7).times(() => _.clone(character)))
              });
            });

            return newGrape;
        }
      };

      const changeTab = (tab, main = null) => {
        store.dispatch({ type: 'CHANGE_TAB', tab, main });
      };

      const runVineyardCultivation = () => {
        console.log('running Vineyard Cultivation');

        const currState = store.getState();
        let currVineyard;
        const refreshVineyardFromStore = () => {
          currVineyard = _.find(store.getState().vineyards, (v) => {
            return v.id == currState.ux.currentMain;
          });
        }
        refreshVineyardFromStore();

        if (!_.isNil(currVineyard.strategy)) {
          store.dispatch({ type: 'CLEAR_VINEYARD_ACTIONS', vineyard: currVineyard.id });
          refreshVineyardFromStore();
        }

        if (_.isNil(currVineyard)) { return; }
        if (_.isNil(currVineyard.grape)) { return; }

        const vineyardGrape = _.find(currState.grapes, (g) => {
          return g.id == currVineyard.grape;
        });

        const stateMap = _.invert({
          'sagging': 'The vines are sagging a bit',
          'wilting': 'Leaves are wilting',
          'musty': 'A musty smell can be detected',
          'fat': 'Stems look especially fat',
          'rustle': 'Leaves rustle in the breeze',
          'shrivel': 'The grapes are starting to shrivel',
          'shimmer': 'Leaves shimmer with moisture'
        });

        const tendMap = _.invert({
          'as': 'Aerate the soil',
          'mg': 'Mist the grapes',
          'po': 'Pinch off the weakest stems',
          'sl': 'Shade the leaves',
          'sv': 'Spread out the vines',
          'tv': 'Tie the vines to the trellis',
          'tl': 'Trim the lower leaves'
        });

        const stepsUntilNilTend = (() => {
          const index = _.findIndex(currVineyard.steps, (vStep) => {
            return _.isNil(vStep.tend);
          })
          return index == -1 ? currVineyard.steps.length-1 : index;
        })() + 1;

        if (!_.isNil(_.last(currVineyard.steps).tend) &&
            stepsUntilNilTend >= Math.max(1, _.size(currVineyard.states))) {
          store.dispatch({ type: 'ADD_STATES', vineyard: currVineyard.id, num: 1 });
          refreshVineyardFromStore();
        }

        if (stepsUntilNilTend >= currVineyard.steps.length) {
          currVineyard.steps.push({ step: _.last(currVineyard.steps).step + 1 });
        }

        const strategy = _.find(vineyardStrategies,
          (strategy) => strategy.name == currVineyard.strategy);

        const cultivate = (previousStep, step) => {
          const tend = vineyardGrape[
            stateMap[currVineyard.states[previousStep.step]]
          ][
            tendMap[previousStep.tend]
          ];

          if ((previousStep.vigor + tend.v) <= 0) {
            return {
              tend: step.tend,
              step: step.step,
              acid: '--',
              color: '--',
              grapes: '--',
              quality: '--',
              skin: '--',
              sugar: '--',
              vigor: '--'
            };
          }

          return {
            tend: step.tend,
            acid: Math.max(0, previousStep.acid + tend.a),
            color: Math.max(0, previousStep.color + tend.c),
            grapes: Math.max(0, previousStep.grapes + tend.g),
            quality: Math.max(0, previousStep.quality + tend.q),
            skin: Math.max(0, previousStep.skin + tend.k),
            sugar: Math.max(0, previousStep.sugar + tend.s),
            vigor: Math.max(0, previousStep.vigor + tend.v),
            step: step.step
          };
        };

        const steps = _.reduce(currVineyard.states,
          (cultivation, state, index) => {
            const step = currVineyard.steps[index];

            if (_.isNil(step)) {
              cultivation.push({ step: _.last(cultivation).step + 1 });
              return cultivation;
            }

            if (step.step === 0) {
              cultivation.push(step);
              return cultivation;
            }

            const previousStep = _.last(cultivation);

            if (previousStep.vigor == '--') {
              return cultivation;
            }

            if (_.isNil(previousStep.tend)) {
              if (_.isNil(strategy)) {
                cultivation.push(step);
                return cultivation;
              }

              const action = _.invert(tendMap)[strategy.evaluate(
                stateMap[currVineyard.states[previousStep.step]],
                vineyardGrape
              )];
              store.dispatch({
                type: 'UPDATE_VINEYARD_ACTION',
                vineyard: currVineyard.id,
                index: previousStep.step,
                action
              });
              refreshVineyardFromStore();
              previousStep.tend = action;
            }

            cultivation.push(cultivate(previousStep, step));

            return cultivation;
          }, []);

        store.dispatch({
          type: 'UPDATE_VINEYARD_CULTIVATION_STEPS',
          vineyard: currVineyard.id,
          steps
        });
      };

      class ListingOptionsComponent extends React.Component {
        render() {
          const listingIndex = _.findIndex(this.props[this.props.ux.currentTab],
            (listing) => { return listing.id == this.props.id });

          const goUp = () => {
            this.props.reorderListing(this.props.id, listingIndex-1);
          };
          const goDown = () => {
            this.props.reorderListing(this.props.id, listingIndex+1);
          };
          const remove = () => {
            this.props.removeListing(this.props.id);
          };

          const firstListing = listingIndex == 0;
          const lastListing =
            listingIndex == this.props[this.props.ux.currentTab].length-1;

          return (<div className="listing-options">
            <button onClick={goUp} disabled={firstListing}>▲</button>
            <button onClick={goDown} disabled={lastListing}>▼</button>
            <button onClick={remove}>✘</button>
          </div>);
        }
      }
      const ListingOptions = ReactRedux.connect(
        (state) => state,
        (dispatch) => { return {
          removeListing: (id) => {
            dispatch({ type: 'REMOVE_LISTING', id });
          },
          reorderListing: (id, index) => {
            dispatch({ type: 'REORDER_LISTING', id, index });
          }
        }; }
      )(ListingOptionsComponent);

      class ListingComponent extends React.Component {
        render() {
          const handle = () => {
            this.props.changeListing(this.props.id);
          };

          const classes = classNames({
            listing: true,
            selected: this.props.id == this.props.ux.currentMain
          });

          return (<div
            className={classes}
            onClick={handle}
            title={this.props.name}>
            <ListingOptions id={this.props.id} />
            {this.props.name}
          </div>);
        }
      }
      const Listing = ReactRedux.connect(
        (state) => state,
        (dispatch) => { return {
          changeListing,
          startDragging: () => {
            dispatch({ type: 'START_DRAGGING_LISTING' });
          }
        }; }
      )(ListingComponent);

      class NewListingComponent extends React.Component {
        render() {
          return (
            <div className="listing new-listing" onClick={this.props.createListing}>
              + create new
            </div>
          );
        }
      }
      const NewListing = ReactRedux.connect(
        (state) => state,
        (dispatch) => { return { createListing }; }
      )(NewListingComponent);

      class VineyardListComponent extends React.Component {
        render() {
          const vineyards = this.props.vineyards.map((vineyard) => {
            return <Listing key={vineyard.id} {...vineyard} />
          });

          return (<div id="vineyard-list" className="sidebar">
            {vineyards}
            <NewListing />
          </div>);
        }
      }
      const VineyardList = ReactRedux.connect((state) => state)(VineyardListComponent);

      class CultivationStepComponent extends React.Component {
        constructor(props) {
          super(props);

          _.bindAll(this, [
            'updateState', 'updateAction',
            'setCursor'
          ]);
        }

        vineyardStates() {
          return [
            'The vines are sagging a bit',
            'Leaves are wilting',
            'A musty smell can be detected',
            'Stems look especially fat',
            'Leaves rustle in the breeze',
            'The grapes are starting to shrivel',
            'Leaves shimmer with moisture'
          ].map((state) => {
            return (<option key={state} selected={state == this.props.state}>
              {state}
            </option>);
          });
        }

        tendActions() {
          return [
            '',
            'Aerate the soil',
            'Mist the grapes',
            'Pinch off the weakest stems',
            'Shade the leaves',
            'Spread out the vines',
            'Tie the vines to the trellis',
            'Trim the lower leaves'
          ].map((action) => {
            return (<option key={action} selected={action == this.props.data.tend}>
              {action}
            </option>);
          });
        }

        updateState(evt) {
          this.props.updateState(
            this.props.vineyard,
            this.props.data.step,
            evt.target.value
          );
        }

        updateAction(evt) {
          this.props.updateAction(
            this.props.vineyard,
            this.props.data.step,
            evt.target.value
          );
        }

        setCursor(evt) {
          this.props.updateCursor(this.props.vineyard, this.props.data.step);
        }

        renderCursor() {
          return (<input
            type="radio" name="vineyard"
            checked={this.props.data.step == this.props.cursor}
            onClick={this.setCursor}
            value={this.props.data.step} />);
        }

        render() {
          return (<tr>
            <td><select onChange={this.updateState}>
              {this.vineyardStates()}
            </select></td>
            <td><select onChange={this.updateAction}>
              {this.tendActions()}
            </select></td>
            <td>&nbsp;</td>
            <td>{this.props.data.acid}</td>
            <td>{this.props.data.color}</td>
            <td>{this.props.data.grapes}</td>
            <td>{this.props.data.quality}</td>
            <td>{this.props.data.skin}</td>
            <td>{this.props.data.sugar}</td>
            <td>{this.props.data.vigor}</td>
            <td>{this.renderCursor()}</td>
          </tr>);
        }
      }
      const CultivationStep = ReactRedux.connect(
        (state) => state,
        (dispatch) => { return {
          updateState: (vineyard, index, state) => {
            store.dispatch({ type: 'UPDATE_VINEYARD_STATE', vineyard, index, state });
            runVineyardCultivation();
          },
          updateAction: (vineyard, index, action) => {
            store.dispatch({ type: 'UPDATE_VINEYARD_ACTION', vineyard, index, action });
            runVineyardCultivation();
          },
          updateCursor: (vineyard, cursor) => {
            store.dispatch({ type: 'UPDATE_VINEYARD_CURSOR', vineyard, cursor });
          }
        }}
      )(CultivationStepComponent);

      class VineyardComponent extends React.Component {
        constructor(props) {
          super(props);
        }

        addMoreSteps(num) {
          this.props.addStates(this.props.vineyard.id, num)
        }

        renderAddMoreSteps() {
          const buttons = [ 1, 5, 10 ].map((num) => {
            return (<button key={num} onClick={() => this.addMoreSteps(num)}>
              +{num}
            </button>);
          });
          return (<tr>
            <td>
              {buttons}
            </td>
          </tr>);
        }

        render() {
          const cultivationSteps = (this.props.vineyard.states || [defaultState]).
            map((state, index) => {
              const step = this.props.vineyard.steps[index] || { step: index };
              return <CultivationStep
                key={index} vineyard={this.props.vineyard.id}
                cursor={this.props.vineyard.cursor}
                state={state} data={step} />
            });

          return (<table className="vineyard">
            <thead><tr>
              <th>State</th>
              <th>Action to Take</th>
              <th>&nbsp;</th>
              <th>Acid</th>
              <th>Color</th>
              <th>Grapes</th>
              <th>Quality</th>
              <th>Skin</th>
              <th>Sugar</th>
              <th>Vigor</th>
            </tr></thead>
            <tbody>
              {cultivationSteps}
              {this.renderAddMoreSteps()}
            </tbody>
          </table>);
        }
      }
      const Vineyard = ReactRedux.connect(
        (state) => state,
        (dispatch) => { return {
          addStates: (vineyard, num) => {
            store.dispatch({ type: 'ADD_STATES', vineyard, num });
            runVineyardCultivation();
          }
        }}
      )(VineyardComponent);

      class VineyardDesignerComponent extends React.Component {
        constructor(props) {
          super(props);

          _.bindAll(this, [
          'changeGrape', 'changeStrategy', 'updateName', 'showDetails',
          'updateMeta', 'distillName'
          ]);
        }

        changeGrape(evt) {
          this.props.changeGrape(this.vineyard.id, evt.target.value);
        }

        grapeList() {
          return this.props.grapes.map((grape) => {
            return <option key={grape.id} value={grape.id} selected={grape.id == this.vineyard.grape}>
              {grape.name}
            </option>
          });
        }

        changeStrategy(evt) {
          this.props.changeStrategy(this.vineyard.id, evt.target.value);
        }

        strategyList() {
          return _.tap(vineyardStrategies.map((strat) => {
            return <option key={strat.name}
              value={strat.name} selected={this.vineyard.strategy == strat.name}>
                {strat.name}
            </option>;
          }), (list) => { list.unshift(<option>Custom</option>); });
        }

        updateName(evt) {
          this.props.updateName(this.vineyard.id, evt.target.value);
        }

        showDetails(evt) {
          changeTab('grapes', this.vineyard.grape);
        }

        readMeta() {
          const region = this.metaRef.querySelector('#region').value;
          const [ x, y ] = _.map(this.metaRef.querySelectorAll('input'), (i) => i.value);
          const flavors = _.map(this.metaRef.querySelectorAll('.flavor'), (i) => i.value);

          return {
            region, x, y, flavors
          };
        }

        updateMeta() {
          this.props.updateMeta(this.vineyard.id, this.readMeta());
        }

        renderRegions() {
          const regions = [
              '',"CCR","CotS","DoN","DoS","EG","4C","LoR","MV",
              "OE","RP","7L","Sinai","SE","VoK"].map(
            (region) => {
              return <option key={region} selected={region == _.get(this.vineyard, 'meta.region')}>{region}</option>;
            });
          return <select id="region" onChange={this.updateMeta}>
            {regions}
          </select>;
        }

        renderCoord(axis) {
          const props = {
            x: {
              min: -3070,
              max: 5120,
              value: _.get(this.vineyard, 'meta.x')
            },
            y: {
              min: -8200,
              max: 8200,
              value: _.get(this.vineyard, 'meta.y')
            }
          }[axis];
          return <input type="number" onChange={this.updateMeta} {...props}/>;
        }

        renderFlavors(index) {
          const currentFlavor = _.get(this.vineyard, `meta.flavors.${index}`);
          const flavors = vineyardFlavors.map((flavor) => {
            return <option key={flavor}
            selected={currentFlavor == flavor}>
              {flavor}
            </option>;
          });
          return <select title={currentFlavor} className="flavor" onChange={this.updateMeta}>
            {flavors}
          </select>;
        }

        distillName() {
          const { region, x, y, flavors } = this.readMeta();

          const states = this.vineyard.states.map((state) => {
            return {
              'The vines are sagging a bit': 'G',
              'Leaves are wilting': 'W',
              'A musty smell can be detected': 'M',
              'Stems look especially fat': 'F',
              'Leaves rustle in the breeze': 'R',
              'The grapes are starting to shrivel': 'V',
              'Leaves shimmer with moisture': 'H'
            }[state];
          }).join('');

          this.props.updateName(this.vineyard.id,
            `${region} (${x},${y}) ${states}: ${flavors.join(', ')}`.slice(0, 126)
          );
        }

        render() {
          this.vineyard = _.find(this.props.vineyards, (vineyard) => {
            return vineyard.id == this.props.vineyard;
          });

          if (_.isNil(this.vineyard)) {
            return (<div id="vineyard-main" className="main"></div>);
          }

          const grapeDetail = (() => {
            if (_.isNil(this.vineyard.grape)) { return; }
            return (<span
              className="show-grape-detail"
              onClick={this.showDetails}>(details)
            </span>);
          })();

          return (<div id="vineyard-main" className="main">
            <div className="vineyard-information information">
              <div>
                <div>Name:
                  <input type="text"
                    onChange={this.updateName}
                    value={this.vineyard.name} />
                </div>
                <div>Grape:
                  <select onChange={this.changeGrape}>
                    <option></option>
                    {this.grapeList()}
                  </select>
                  {grapeDetail}
                </div>
                <div>Strategy:
                  <select onChange={this.changeStrategy}>
                    {this.strategyList()}
                  </select>
                </div>
              </div>
              <div className="vineyard-meta" ref={(ref) => this.metaRef = ref}>
                <div>Location:
                  {this.renderRegions()}
                  {this.renderCoord('x')}
                  {this.renderCoord('y')}
                </div>
                <div>Flavors:
                  {this.renderFlavors(0)}
                  {this.renderFlavors(1)}
                  {this.renderFlavors(2)}
                </div>
                <div>
                  <button onClick={this.distillName}>Auto-Generate a Name!</button>
                </div>
              </div>
            </div>

            <Vineyard vineyard={this.vineyard} />
          </div>);
        }
      }
      const VineyardDesign = ReactRedux.connect(
        (state) => state,
        (dispatch) => { return {
          changeGrape: (vineyard, grape) => {
            store.dispatch({ type: 'UPDATE_VINEYARD_GRAPE', vineyard, grape });
            runVineyardCultivation();
          },
          changeStrategy: (vineyard, strategy) => {
            store.dispatch({ type: 'UPDATE_VINEYARD_STRATEGY', vineyard, strategy });
            runVineyardCultivation();
          },
          updateName: (vineyard, name) => {
            store.dispatch({ type: 'UPDATE_VINEYARD_NAME', vineyard, name });
          },
          updateMeta: (vineyard, meta) => {
            store.dispatch({ type: 'UPDATE_VINEYARD_META', vineyard, meta });
          }
        }}
      )(VineyardDesignerComponent);

      class VineyardViewComponent extends React.Component {
        render() {
          return(<div id="vineyard-view" className="view">
            <VineyardList />
            <VineyardDesign vineyard={this.props.ux.currentMain} />
          </div>);
        }
      }
      const VineyardView = ReactRedux.connect(
        (state) => state
      )(VineyardViewComponent);

      class GrapeListComponent extends React.Component {
        render() {
          const grapes = this.props.grapes.map((grape) => {
            return <Listing key={grape.id} {...grape} />
          });

          return (<div id="grape-list" className="sidebar">
            {grapes}
            <NewListing />
          </div>);
        }
      }
      const GrapeList = ReactRedux.connect((state) => state)(GrapeListComponent);

      class TendTableComponent extends React.Component {
        constructor(props) {
          super(props);

          _.bindAll(this, [
            'updateNumber'
          ]);
        }

        updateNumber(tend, characteristic, value) {
          this.props.updateNumber(this.props.grape, [ this.props.state, tend, characteristic ], value);
        }

        header() {
          const map = {
            'sagging': 'The vines are sagging a bit',
            'wilting': 'Leaves are wilting',
            'musty': 'A musty smell can be detected',
            'fat': 'Stems look especially fat',
            'rustle': 'Leaves rustle in the breeze',
            'shrivel': 'The grapes are starting to shrivel',
            'shimmer': 'Leaves shimmer with moisture'
          }[this.props.state];
          return (<div className="tend-table-header">
            {capitalize(this.props.state)}: ({map})
          </div>);
        }

        tendAction(abbrev) {
          return {
            'as': 'Aerate the soil',
            'mg': 'Mist the grapes',
            'po': 'Pinch off the weakest stems',
            'sl': 'Shade the leaves',
            'sv': 'Spread out the vines',
            'tv': 'Tie the vines to the trellis',
            'tl': 'Trim the lower leaves'
          }[abbrev];
        }

        renderNumber(tend, characteristic) {
          const key=`${this.props.state}-${tend}-${characteristic}`;
          const data = this.props.data[this.props.state][tend][characteristic];

          return <input
            type="number" step="1"
            onChange={(evt) =>
              this.updateNumber(tend, characteristic, evt.target.valueAsNumber)}
            value={data} />;
        }

        renderTend(tend) {
          return (<tr key={tend}>
            <td>{this.tendAction(tend)}</td>
            <td>&nbsp;</td>
            <td>{this.renderNumber(tend, 'a')}</td>
            <td>{this.renderNumber(tend, 'c')}</td>
            <td>{this.renderNumber(tend, 'g')}</td>
            <td>{this.renderNumber(tend, 'q')}</td>
            <td>{this.renderNumber(tend, 'k')}</td>
            <td>{this.renderNumber(tend, 's')}</td>
            <td>{this.renderNumber(tend, 'v')}</td>
          </tr>);
        }

        render() {
          const data = ['as', 'mg', 'po', 'sl', 'sv', 'tv', 'tl'].map((tend) => {
            return this.renderTend(tend);
          });

          return (<div className="tend-table">
            {this.header()}
            <table>
              <thead><tr>
                <th>Tending Action</th>
                <th>&nbsp;</th>
                <th>Acid</th>
                <th>Color</th>
                <th>Grapes</th>
                <th>Quality</th>
                <th>Skin</th>
                <th>Sugar</th>
                <th>Vigor</th>
              </tr></thead>
              <tbody>
                {data}
              </tbody>
            </table>
          </div>);
        }
      }
      const TendTable = ReactRedux.connect(
        (state) => state,
        (dispatch) => { return {
          updateNumber: (grape, path, num) => {
            store.dispatch({ type: 'UPDATE_GRAPE_NUMBER', grape, path, num });
          }
        }}
      )(TendTableComponent);

      class GrapeDesignerComponent extends React.Component {
        constructor(props) {
          super(props);

          _.bindAll(this, [
            'updateStarting', 'updateName', 'updateMeta'
          ]);
        }

        updateStarting(evt) {
          this.props.updateStarting(this.grape.id, evt.target.valueAsNumber);
        }

        updateName(evt) {
          this.props.updateName(this.grape.id, evt.target.value);
        }

        updateMeta(evt) {
          this.props.updateMeta(this.grape.id, this.readMeta());
        }

        readMeta() {
          const url = this.metaRef.querySelector('.grape-url').value;
          const phenotype = this.metaRef.querySelector('.grape-phenotype').value;
          const hue = this.metaRef.querySelector('select').value;

          return { url, phenotype, hue };
        }

        renderUrl() {
          const url = _.get(this.grape, 'meta.url');

          if (url) {
            return <span>(<a href={url}>link</a>)</span>;
          }
        }

        renderHues() {
          const hues = [ '', 'White', 'Rose', 'Light Red', 'Red',
            'Dark Red', 'Purple-Red', 'Purple', 'Deep Purple'
          ].map((hue) => {
            return <option key={hue} selected={hue == _.get(this.grape, 'meta.hue')}>
              {hue}
            </option>;
          });

          return <select onChange={this.updateMeta}>
            {hues}
          </select>;
        }

        render() {
          this.grape = _.find(this.props.grapes, (grape) => {
            return grape.id == this.props.grape;
          });

          if (_.isNil(this.grape)) {
            return (<div id="grape-main" className="main"></div>);
          }

          const tendTables =
            ['sagging', 'wilting', 'musty', 'fat', 'rustle', 'shrivel', 'shimmer'].map(
            (state) => {
              return <TendTable key={state}
                grape={this.grape.id} state={state} data={this.grape} />
            });

          return (<div id="grape-main" className="main">
            <div className="grape-information information">
              <div>
                <div>Name:
                  <input type="text"
                    onChange={this.updateName}
                    value={this.grape.name} />
                </div>
                <div>Starting Grapes:
                  <input
                  type="number" min="0" step="1"
                  onChange={this.updateStarting}
                  value={this.grape.starting} />
                </div>
              </div>
              <div className="grape-meta" ref={(ref) => this.metaRef = ref}>
                <div>URL:
                  <input type="text" className="grape-url"
                    onChange={this.updateMeta}
                    value={_.get(this.grape, 'meta.url', '')}/>
                  {this.renderUrl()}
                </div>
                <div>Phenotype:
                  <input type="text" className="grape-phenotype"
                    onChange={this.updateMeta}
                    value={_.get(this.grape, 'meta.phenotype', '')}/>
                </div>
                <div>Hue: {this.renderHues()}</div>
              </div>
            </div>

            {tendTables}
          </div>);
        }
      }
      const GrapeDesign = ReactRedux.connect(
        (state) => state,
        (dispatch) => { return {
          changeListing,
          updateStarting: (grape, starting) => {
            store.dispatch({ type: 'UPDATE_GRAPE_STARTING', grape, starting });
          },
          updateMeta: (grape, meta) => {
            store.dispatch({ type: 'UPDATE_GRAPE_META', grape, meta });
          },
          updateName: (grape, name) => {
            store.dispatch({ type: 'UPDATE_GRAPE_NAME', grape, name });
          }
        }}
      )(GrapeDesignerComponent);

      class GrapeViewComponent extends React.Component {
        render() {
          return(<div id="grape-view" className="view">
            <GrapeList />
            <GrapeDesign grape={this.props.ux.currentMain} />
          </div>);
        }
      }
      const GrapeView = ReactRedux.connect(
        (state) => state
      )(GrapeViewComponent);

      class BarrelView extends React.Component {
        render() {
          return <div>LOL have not even started</div>;
        }
      }

      class HelpView extends React.Component {
        render() {
          return (<div className="view">
            <div>
              Something about how to use stuff, plus a bunch of guides.
              <br /><br />
              <a href="http://www.atitd.org/wiki/tale7/Wine">
                http://www.atitd.org/wiki/tale7/Wine
              </a>
              <br /><br />
              Recommended Vineyard naming scheme: "OE 1234,1234 [States] Flavors" (character limit 126; max flavor string length is 19) Region - 3, X - 5, Y - 5, Flavors - 19*3+2 - 59. That's 72. 120-72 = 48 left.
            </div>
          </div>);
        }
      }

      class AboutView extends React.Component {
        render() {
          return (<div className="view">
            <div>
              TODO:
              <ul>
                <li>Allow export/import of grapes.</li>
                <li>Allow export/import of vineyards.</li>
                <li>Create vineyard strategies.</li>
                <li>Create concept of barrels.</li>
              </ul>
            </div>
            <div>
              Moonshot:
              <ul>
                <li>Allow reverting.</li>
                <li>Track changes.</li>
                <li>Allow undo/redo.</li>
              </ul>
            </div>
          </div>);
        }
      }

      class ApplicationComponent extends React.Component {
        render() {
          const renderTab = (tab) => {
            const key = tab.toLowerCase();
            const handle = () => { this.props.changeTab(key); };
            const classes = classNames({ tab: true, selected: this.props.ux.currentTab == key });
            return (<div key={key} className={classes} onClick={handle}>
              {tab}
            </div>);
          };

          const tabs = [ 'Barrels', 'Vineyards', 'Grapes' ].map(renderTab);
          const infos = [ 'Help', 'About' ].map(renderTab);

          const view = {
            'barrels': () => <BarrelView />,
            'grapes': () => <GrapeView />,
            'vineyards': () => <VineyardView />,
            'help': () => <HelpView />,
            'about': () => <AboutView />,
          }[this.props.ux.currentTab]();

          return(<div id="app">
            <div id="header">
              Manage:
              {tabs}
              <div id="header-info">Info:</div>
              {infos}
            </div>
            {view}
          </div>);
        }
      }
      const Application = ReactRedux.connect(
        (state) => state,
        (dispatch) => { return {
          changeTab
        }}
      )(ApplicationComponent);

      ReactDOM.render(
        <ReactRedux.Provider store={store}>
          <Application />
        </ReactRedux.Provider> ,
        document.getElementById('root')
      );
    </script>
  </body>
</html>
